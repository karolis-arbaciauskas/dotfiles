#!/usr/bin/env bash
set -e

KEY_NAME="GitHub SSH Key"
VAULT="Private"

# Try to get existing item ID
ITEM_ID=$(op item get "$KEY_NAME" --vault "$VAULT" --format json 2>/dev/null | jq -r '.id' || echo "")

# Create key if it doesn't exist
if [ -z "$ITEM_ID" ]; then
  echo "ğŸ” Creating SSH key in 1Password..."
  ITEM_ID=$(op item create --category ssh --title "$KEY_NAME" --vault "$VAULT" --ssh-generate-key={{ .sshKeyType }} --format json | jq -r '.id')
  echo "âœ… SSH key created"
else
  echo "âœ… SSH key already exists in 1Password"
fi

# Get public key
PUBLIC_KEY=$(op item get "$ITEM_ID" --fields label=public_key)

# Configure Git signing key
git config --global user.signingkey "$PUBLIC_KEY"

# Print setup instructions
echo ""
echo "âœ… Git signing key configured"
echo ""
echo "ğŸ‘‰ Add this SSH public key to GitHub as a SIGNING KEY:"
echo "$PUBLIC_KEY"
echo ""
echo "ğŸ“ Steps:"
echo "1. Go to: https://github.com/settings/keys"
echo "2. Click 'New SSH key'"
echo "3. Set 'Key type' to 'Signing Key'"
echo "4. Paste the public key above"
echo "5. Click 'Add SSH key'"
echo ""
